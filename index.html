<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rob√¥ (imagem completa) + √°udio</title>
  <style>
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      height:100svh;
      overflow:hidden;
      background:#000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select:none;
    }

    /* Tela cheia */
    .stage{
      position:fixed;
      inset:0;
      width:100vw;
      height:100svh;
      display:block;
      overflow:hidden;
      background:#000;
      padding:
        env(safe-area-inset-top)
        env(safe-area-inset-right)
        env(safe-area-inset-bottom)
        env(safe-area-inset-left);
    }

    /* Imagem do rob√¥ (corpo inteiro) */
    .bg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;        /* preenche tudo */
      object-position: center;  /* centraliza */
      transform: translateZ(0);
      filter: saturate(1.05) contrast(1.03);
    }

    /* Camada por cima para anima√ß√µes */
    .overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
    }

    /* Barra de ‚Äúvolume‚Äù (discreta) */
    .meter{
      position:absolute;
      left: 12px;
      right: 12px;
      top: 12px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
    }
    .meter > div{
      height:100%;
      width:0%;
      background: rgba(120,220,255,.92);
    }

    /* === OLHOS (pupilas por cima da imagem) ===
       Ajuste fino f√°cil via --eyeY e --eyeGap */
    :root{
      --eyeY: 21.5%;      /* altura dos olhos */
      --eyeGap: 17.8%;    /* dist√¢ncia entre olhos */
      --pupilSize: 3.2vw; /* tamanho pupila (responsive) */
      --pupilMin: 16px;
      --pupilMax: 28px;
    }

    .pupil{
      position:absolute;
      top: var(--eyeY);
      width: clamp(var(--pupilMin), var(--pupilSize), var(--pupilMax));
      height: clamp(var(--pupilMin), var(--pupilSize), var(--pupilMax));
      border-radius: 999px;
      left: 50%;
      transform: translate(-50%,-50%);
      background: radial-gradient(circle at 35% 35%, rgba(30,30,30,.95) 0 45%, rgba(0,0,0,.98) 70% 100%);
      box-shadow:
        0 0 14px rgba(0,0,0,.35),
        0 0 26px rgba(80,190,255,.10);
      opacity:.92;
      mix-blend-mode: multiply;
    }
    .pupil.left{ margin-left: calc(-1 * var(--eyeGap)); }
    .pupil.right{ margin-left: var(--eyeGap); }

    /* Piscar (uma p√°lpebra por cima da √°rea do olho) */
    .lid{
      position:absolute;
      left:50%;
      top: calc(var(--eyeY) - 3.8%);
      width: 18%;
      height: 14%;
      transform: translate(-50%,-50%);
      border-radius: 999px;
      background: linear-gradient(rgba(10,20,30,.85), rgba(10,20,30,0));
      opacity:0;
      filter: blur(0.2px);
      animation: blink 4.6s infinite;
      mix-blend-mode: multiply;
    }
    .lid.left{ margin-left: calc(-1 * var(--eyeGap)); animation-delay: .10s; }
    .lid.right{ margin-left: var(--eyeGap); animation-delay: .28s; }

    @keyframes blink{
      0%, 92%, 100% { opacity:0; transform: translate(-50%,-50%) scaleY(0.15); }
      94% { opacity:1; transform: translate(-50%,-50%) scaleY(1.05); }
      96% { opacity:0; transform: translate(-50%,-50%) scaleY(0.15); }
    }

    /* === BOCA (sobrepor na boca da imagem) ===
       Ajuste fino via --mouthY e --mouthW */
    :root{
      --mouthY: 29.8%;
      --mouthW: 22%;
      --mouthH: 10%;
    }

    .mouth{
      position:absolute;
      left:50%;
      top: var(--mouthY);
      width: var(--mouthW);
      height: var(--mouthH);
      transform: translate(-50%,-50%);
      transform-origin: center;
      border-radius: 0 0 999px 999px;
      background: rgba(0,0,0,.55);
      box-shadow:
        0 14px 24px rgba(0,0,0,.35),
        inset 0 10px 18px rgba(255,255,255,.06);
      border: 2px solid rgba(255,255,255,.07);
      overflow:hidden;
      opacity:.0; /* come√ßa invis√≠vel; aparece ao falar */
      pointer-events:none;
      mix-blend-mode: multiply;
    }

    .tongue{
      position:absolute;
      left:50%;
      bottom:-18%;
      width: 64%;
      height: 88%;
      transform: translateX(-50%) scale(0.85);
      border-radius: 999px 999px 70% 70%;
      background: radial-gradient(circle at 50% 35%, #ff9a9a 0 18%, #ff3b3b 55%, #c71818 100%);
      box-shadow: inset 0 -10px 18px rgba(0,0,0,.25);
      opacity:0;
    }

    /* Bot√£o mic */
    .micBtn{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      pointer-events:auto;
    }
    .micBtn button{
      appearance:none;
      border:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:12px;
      padding:16px 18px;
      border-radius:18px;
      font-weight:850;
      font-size:18px;
      color:#07121c;
      background: linear-gradient(135deg, #39c6ff, #2a8bff);
      box-shadow: 0 18px 36px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.25);
      max-width:min(360px, 86vw);
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
    }
    .micBtn button:active{ transform: scale(.98); filter: brightness(1.03); }
    .micBtn button:disabled{ cursor:default; opacity:.88; }
    .micIcon{
      width:38px; height:38px; border-radius:12px;
      background: rgba(255,255,255,.25);
      display:grid; place-items:center;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.22);
      flex:0 0 auto;
    }
    .micIcon svg{ width:22px; height:22px; }
    .btnText{ display:flex; flex-direction:column; line-height:1.05; text-align:left; }
    .btnTitle{ font-size:18px; }
    .sub{ font-size:13px; font-weight:650; opacity:.95; margin-top:6px; }

    .hint{
      position:absolute;
      left:0; right:0; bottom: 10px;
      display:grid;
      place-items:center;
      padding: 12px 16px;
      pointer-events:none;
    }
    .pill{
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 10px 14px;
      backdrop-filter: blur(8px);
      font-size: 13px;
      line-height: 1.2;
      color:#d9f1ff;
      opacity:.98;
      text-align:center;
    }
    .pill strong{ color:#fff; font-weight:850; }

    @media (prefers-reduced-motion: reduce){
      .lid{ animation:none; }
      .micBtn button{ transition:none; }
    }
  </style>
</head>

<body>
  <div class="stage">
    <!-- ‚úÖ Coloque a imagem completa do rob√¥ na mesma pasta e renomeie para robo.png -->
    <img class="bg" src="robo.png" alt="Rob√¥" />

    <div class="overlay">
      <div class="meter"><div id="bar"></div></div>

      <!-- Pupilas + piscar -->
      <div class="pupil left"  id="pL"></div>
      <div class="pupil right" id="pR"></div>
      <div class="lid left"></div>
      <div class="lid right"></div>

      <!-- Boca -->
      <div class="mouth" id="mouth">
        <div class="tongue" id="tongue"></div>
      </div>

      <!-- Bot√£o -->
      <div class="micBtn" id="micBtn">
        <button id="startBtn" type="button" aria-label="Ligar microfone">
          <span class="micIcon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Z" stroke="rgba(7,18,28,.95)" stroke-width="2" stroke-linecap="round"/>
              <path d="M19 11a7 7 0 0 1-14 0" stroke="rgba(7,18,28,.95)" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 18v3" stroke="rgba(7,18,28,.95)" stroke-width="2" stroke-linecap="round"/>
              <path d="M9 21h6" stroke="rgba(7,18,28,.95)" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </span>
          <span class="btnText">
            <span class="btnTitle" id="btnTitle">Ligar microfone</span>
            <span class="sub" id="btnSub">Toque e deixe o rob√¥ ‚Äúfalar‚Äù üòä</span>
          </span>
        </button>
      </div>

      <div class="hint" id="hint">
        <div class="pill" id="pillText">
          <strong>Dica:</strong> se der ‚Äúnegado‚Äù, abra o cadeado do navegador e permita o microfone.
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  let audioCtx, analyser, data, stream;
  let running = false;

  const bar = document.getElementById("bar");
  const mouth = document.getElementById("mouth");
  const tongue = document.getElementById("tongue");

  const pL = document.getElementById("pL");
  const pR = document.getElementById("pR");

  const micBtn = document.getElementById("micBtn");
  const startBtn = document.getElementById("startBtn");
  const btnTitle = document.getElementById("btnTitle");
  const btnSub = document.getElementById("btnSub");
  const hint = document.getElementById("hint");
  const pillText = document.getElementById("pillText");

  // Sensibilidade / anima√ß√£o
  const SENS = 2.05;
  const SMOOTH = 0.22;

  // Boca
  const OPEN_MIN = 0.85;
  const OPEN_MAX = 1.85;

  // Sil√™ncio => olhos ‚Äúdesconfiados‚Äù
  const SILENCE_TH = 0.020; // ajuste se precisar (0.015 a 0.03)
  let smoothLevel = 0;
  let idleT = 0;

  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

  function computeRms(bytes){
    let sum = 0;
    for (let i=0;i<bytes.length;i++){
      const n = (bytes[i] - 128) / 128;
      sum += n*n;
    }
    return Math.sqrt(sum / bytes.length);
  }

  function stopStream(){
    try{
      if (stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      if (audioCtx){
        audioCtx.close();
        audioCtx = null;
      }
    }catch(_){}
  }

  function setButtonState(state){
    if (state === "idle"){
      startBtn.disabled = false;
      btnTitle.textContent = "Ligar microfone";
      btnSub.textContent = "Toque e deixe o rob√¥ ‚Äúfalar‚Äù üòä";
    } else if (state === "loading"){
      startBtn.disabled = true;
      btnTitle.textContent = "Aguarde‚Ä¶";
      btnSub.textContent = "Abrindo permiss√£o do microfone‚Ä¶";
    } else if (state === "ok"){
      startBtn.disabled = true;
      btnTitle.textContent = "Microfone ligado ‚úÖ";
      btnSub.textContent = "Pronto! Pode falar üôÇ";
    }
  }

  async function startMic(){
    if (running) return;

    running = true;
    setButtonState("loading");

    try{
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        throw new Error("getUserMedia n√£o dispon√≠vel neste navegador.");
      }

      const AC = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AC();
      if (audioCtx.state === "suspended") {
        try { await audioCtx.resume(); } catch(_) {}
      }

      stream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: false,
          noiseSuppression: false,
          autoGainControl: true
        }
      });

      const source = audioCtx.createMediaStreamSource(stream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 1024;
      data = new Uint8Array(analyser.fftSize);
      source.connect(analyser);

      setButtonState("ok");
      hint.style.display = "none";
      setTimeout(() => { micBtn.style.display = "none"; }, 800);

      loop();
    } catch (e){
      running = false;
      stopStream();
      setButtonState("idle");

      hint.style.display = "grid";
      pillText.innerHTML =
        "<strong>Ops!</strong> N√£o consegui acessar o microfone.<br/>" +
        "Abra o cadeado do site ‚Üí Permiss√µes ‚Üí Microfone ‚Üí <strong>Permitir</strong>.";
      console.error(e);
    }
  }

  function animateEyes(level){
    // no sil√™ncio, pupilas passeiam e d√£o ‚Äúdesconfian√ßa‚Äù
    if (level < SILENCE_TH){
      idleT += 0.045;

      // movimentos suaves
      const x = Math.sin(idleT) * 7;           // px
      const y = Math.cos(idleT * 0.7) * 4.5;   // px

      pL.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      pR.style.transform = `translate(calc(-50% - ${x*0.7}px), calc(-50% + ${y*0.6}px))`;

      // boca some no sil√™ncio
      mouth.style.opacity = "0";
      tongue.style.opacity = "0";
    } else {
      // ao falar, centraliza
      idleT = 0;
      pL.style.transform = "translate(-50%,-50%)";
      pR.style.transform = "translate(-50%,-50%)";
    }
  }

  function loop(){
    if (!running) return;

    analyser.getByteTimeDomainData(data);

    let level = computeRms(data) * SENS;
    smoothLevel = smoothLevel + (level - smoothLevel) * (1 - SMOOTH);
    level = smoothLevel;

    // barra
    const pct = clamp(level * 120, 0, 100);
    bar.style.width = pct + "%";

    // olhos
    animateEyes(level);

    // boca (aparece ao falar)
    if (level >= SILENCE_TH){
      const open = clamp(OPEN_MIN + level * (OPEN_MAX - OPEN_MIN), OPEN_MIN, OPEN_MAX);
      const opacity = clamp((level - SILENCE_TH) * 18, 0, 1); // come√ßa discreto e sobe
      mouth.style.opacity = opacity.toFixed(2);

      // ‚Äúabre‚Äù e cresce
      mouth.style.transform = `translate(-50%,-50%) scaleY(${open})`;

      // l√≠ngua
      const tOpacity = clamp(level * 2.2, 0, 1);
      const tScale = clamp(0.82 + level * 0.95, 0.82, 1.65);
      tongue.style.opacity = tOpacity.toFixed(2);
      tongue.style.transform = `translateX(-50%) scale(${tScale})`;
    }

    requestAnimationFrame(loop);
  }

  startBtn.addEventListener("click", startMic);
})();
</script>
</body>
</html>
